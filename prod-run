#!/bin/bash
# Production script runner
# Usage: ./prod-run <script_name.py> [--build] [script arguments...]

set -e

RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Parse arguments
BUILD_FLAG=""
SCRIPT_NAME=""
SCRIPT_ARGS=()

for arg in "$@"; do
    if [ "$arg" == "--build" ]; then
        BUILD_FLAG="--build"
    elif [ -z "$SCRIPT_NAME" ]; then
        SCRIPT_NAME="$arg"
    else
        SCRIPT_ARGS+=("$arg")
    fi
done

if [ -z "$SCRIPT_NAME" ]; then
    echo "Error: No script name provided"
    echo "Usage: ./prod-run <script_name.py> [--build] [script arguments...]"
    echo ""
    echo "Available scripts:"
    ls -1 app/backend/scripts/*.py 2>/dev/null | xargs -n 1 basename || echo "  No scripts found"
    exit 1
fi

if [ ! -f "app/backend/scripts/$SCRIPT_NAME" ]; then
    echo "Error: Script 'app/backend/scripts/$SCRIPT_NAME' not found"
    echo ""
    echo "Available scripts:"
    ls -1 app/backend/scripts/*.py 2>/dev/null | xargs -n 1 basename || echo "  No scripts found"
    exit 1
fi

echo -e "${RED}üö® PRODUCTION: Running $SCRIPT_NAME ${SCRIPT_ARGS[*]}${NC}"
echo -e "${YELLOW}‚ö†Ô∏è  This will affect PRODUCTION data!${NC}"
echo ""
read -p "Are you sure you want to continue? (yes/no): " confirmation

if [ "$confirmation" != "yes" ]; then
    echo "Aborted."
    exit 0
fi

# Build if requested
if [ "$BUILD_FLAG" == "--build" ]; then
    echo "üî® Building Docker image..."
    docker compose --profile prod build scripts-prod
fi

docker compose --profile prod run --rm scripts-prod bash -c "cd /app && PYTHONPATH=/app python scripts/$SCRIPT_NAME ${SCRIPT_ARGS[*]}"
